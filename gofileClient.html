<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Gestor de Folders</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Martian+Mono:wght@500&display=swap" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <link rel="stylesheet" href="modal.css">
  <style>
  body { font-family: 'Martian Mono', monospace; }
  /* Modal navigation and media constraints */
  .mm-viewer { position: relative; }
  .mm-nav-btn { position: absolute; top: 33%; height: 34%; width: 44px; min-width:44px; background: rgba(0,0,0,0.35); border-radius:6px; border:none; color:#fff; }
  .mm-nav-btn.prev { left: 8px; }
  .mm-nav-btn.next { right: 8px; }
  /* Videos inside the viewer should not exceed 50% of parent dimensions */
  .mm-viewer video, .mm-viewer iframe { max-width:50%; max-height:50%; display:block; margin:0 auto; }
  /* Explorer styles */
  .folder-row { padding:10px; border-radius:8px; background: rgba(255,255,255,0.03); margin-bottom:8px; }
  .folder-row:hover { background: rgba(255,255,255,0.05); }
  .preview-thumb { width:80px; height:60px; object-fit:cover; border-radius:6px; margin-right:10px; background:#111; }
  .item-meta { font-size:12px; color:#ddd; }
  .folder-list-flex { display:flex; align-items:center; gap:12px; overflow: hidden;}
  /* Register form styles */
  #folderName, #folderId { max-width: 320px; }
  #foldersList .list-group-item { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  #foldersList .list-group-item .folder-link { font-weight:600; color:#0d6efd; text-decoration:none; }
  #foldersList .list-group-item .folder-meta { font-size:12px; color:#999; }
  /* Smaller preview for registered list */
  #foldersList .preview-thumb { width:48px; height:36px; border-radius:4px; }
  </style>
</head>
<body class="p-3">

<!-- Login -->
<div id="loginForm">
  <h3>Iniciar Sesi√≥n</h3>
  <div class="mb-3">
    <input type="text" id="loginUsername" class="form-control" placeholder="Usuario">
  </div>
  <div class="mb-3">
    <input type="password" id="loginPassword" class="form-control" placeholder="Contrase√±a">
  </div>
  <button class="btn btn-primary" onclick="login()">Entrar</button>
  <div id="loginError" class="text-danger mt-2"></div>
</div>

<!-- Dashboard -->
<div id="dashboardApp" style="display:none;">
<h3>Explorar Folder</h3>
<div class="mb-3 d-flex gap-2">
  <input type="text" id="folderInput" class="form-control" placeholder="Ingrese content ID">
  <button class="btn btn-primary" onclick="changeFolder()">Abrir Folder</button>
</div>

<div id="folderContent" class="mb-3"></div>

<div class="mb-3 d-flex gap-2">
  <button class="btn btn-secondary" onclick="prevPage()">‚¨ÖÔ∏è Anterior</button>
  <button class="btn btn-secondary" onclick="nextPage()">‚û°Ô∏è Siguiente</button>
</div>

<h3>Registrar Folder</h3>
<div class="mb-3 d-flex gap-2">
  <input type="text" id="folderName" class="form-control" placeholder="Nombre del folder">
  <input type="text" id="folderId" class="form-control" placeholder="Content ID">
  <select id="folderSource" class="form-select" style="max-width:160px;">
    <option value="gofile">gofile</option>
    <option value="pixeldrain">pixeldrain</option>
  </select>
  <button class="btn btn-secondary" onclick="fetchExternalMetadata()">Obtener metadata</button>
  <button class="btn btn-success" onclick="registerFolder()">Registrar</button>
</div>

<h3>Folders Registrados</h3>
<ul id="foldersList" class="list-group mb-5"></ul>

</!-- Replaced modal: use the new MM modal markup -->
<div id="mmModal" class="modal">
  <div class="modal-content">
    <div class="mm-topbar">
      <div class="mm-info">
        <div class="mm-title">T√≠tulo del archivo</div>
        <div class="mm-size">123 KB</div>
      </div>
      <div class="mm-buttons">
        <button id="btnLock" aria-label="Bloquear">üîí</button>
        <button id="btnFullscreen">‚õ∂</button>
        <button id="btnClose">‚úï</button>
      </div>
    </div>
    <div class="mm-viewer" id="mmViewer">
      <button class="mm-nav-btn prev" id="mmPrev" aria-label="Anterior"></button>
      <button class="mm-nav-btn next" id="mmNext" aria-label="Siguiente"></button>
      <div class="mm-spinner hidden" id="mmSpinner"><div class="dot"></div><div class="mm-spinner-text">Cargando...</div></div>
    </div>
    <div class="mm-carousel" id="mmCarousel"></div>
  </div>
</div>

<script src="modal.js"></script>
</div>

<script>
// ---------------------- Estado ----------------------
let token = localStorage.getItem("jwtToken");
let currentFolderId = "6b89c061-1617-48ba-9284-ba7fc1280dcd";
let currentPage = 0;
const itemsPerPage = 5;
let currentItems = [];

// Blob pool to cache object URLs and avoid re-downloading images
// Preallocated array with length itemsPerPage. Each slot: { ownerId, contentId, url }
let blobPool = [];

function initBlobPool(ownerId){
  // ownerId: folder id or file id that these blobs belong to
  if(!Array.isArray(blobPool) || blobPool.length !== itemsPerPage){
    blobPool = new Array(itemsPerPage).fill(null).map(()=>({ ownerId: null, contentId: null, url: null }));
  }
  // assign owner to all empty slots
  blobPool.forEach(s => { if(!s.ownerId) s.ownerId = ownerId; });
}

function clearBlobPool(){
  blobPool.forEach(s=>{ if(s && s.url){ try{ URL.revokeObjectURL(s.url); }catch(e){} s.url = null; s.contentId = null; s.ownerId = null; } });
}

async function ensureBlobForSlot(slotIndex, content){
  // content: { id, link }
  const slot = blobPool[slotIndex];
  if(!slot) return null;
  // if owner changed, clear slot
  if(slot.ownerId !== (currentFolderId || content.id)){
    if(slot.url) { try{ URL.revokeObjectURL(slot.url); }catch(e){} }
    slot.url = null; slot.contentId = null; slot.ownerId = currentFolderId || content.id;
  }
    // if slot already has this content, return  
  if(slot.contentId === content.id && slot.url) return slot.url;
  // otherwise fetch the blob and set
  try{
      const fetchUrl = addProxySizeParams(content.link);
      const res = await authFetch(fetchUrl);
    if(!res.ok) throw new Error('fetch failed');
    const blob = await res.blob();
    if(slot.url) { try{ URL.revokeObjectURL(slot.url); }catch(e){} }
    slot.url = URL.createObjectURL(blob);
    slot.contentId = content.id;
    return slot.url;
  }catch(e){ console.error('blob fetch error', e); return null; }
}

// If a URL is a proxy image request (/proxy?content_id=...), add max_width and max_height based on screen size
function addProxySizeParams(url){
  if(!url || typeof url !== 'string') return url;
  try{
    if(url.includes('/proxy?content_id=') || /proxy\?content_id=/i.test(url)){
      const u = new URL(url, window.location.origin);
  u.searchParams.set('max_width', String(screen.width || window.innerWidth || 0));
  u.searchParams.set('max_height', String(screen.height || window.innerHeight || 0));
      return u.toString();
    }
  }catch(e){
    // fallback: append manually if it contains proxy?content_id=
    if(/proxy\?content_id=/i.test(url)){
      return url + (url.includes('?') ? '&' : '?') + 'max_width=' + (screen.width||window.innerWidth||0) + '&max_height=' + (screen.height||window.innerHeight||0);
    }
  }
  return url;
}

// Modal
let modalItems = [];
let modalIndex = 0;
// placeholder: small SVG data URL
const MM_PLACEHOLDER = 'data:image/svg+xml;utf8,' + encodeURIComponent(`
  <svg xmlns="http://www.w3.org/2000/svg" width="240" height="160">
    <rect width="100%" height="100%" fill="#111"/>
    <text x="50%" y="50%" fill="#666" font-size="20" font-family="sans-serif" text-anchor="middle" alignment-baseline="central">No preview</text>
  </svg>
`);

// ---------------------- Autenticaci√≥n ----------------------
function showLogin() {
  document.getElementById("loginForm").style.display = "block";
  document.getElementById("dashboardApp").style.display = "none";
}

function showDashboard() {
  document.getElementById("loginForm").style.display = "none";
  document.getElementById("dashboardApp").style.display = "block";
  showFolder(currentFolderId);
  loadFolders();
}

async function login() {
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value.trim();
  if(!username || !password) return;

  try {
    const res = await fetch("http://40.233.25.130:8000/login", {
      method:"POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({username,password})
    });
    const data = await res.json();
    if(!res.ok) { document.getElementById("loginError").innerText = data.detail || "Error"; return; }
    token = data.token;
    localStorage.setItem("jwtToken", token);
    showDashboard();
  } catch(e){ console.error(e); }
}

// ---------------------- Fetch helpers ----------------------
async function authFetch(url, options={}) {
  options.headers = options.headers || {};
  if(token) options.headers["Authorization"] = "Bearer " + token;
  return fetch(url, options);
}

// ---------------------- Folder ----------------------
async function showFolder(folderId) {
  currentFolderId = folderId;
  currentPage = 0;
  initBlobPool(folderId);
  try {
    const res = await authFetch(`http://40.233.25.130:8000/get_content?content_id=${encodeURIComponent(folderId)}`);
    if(res.status===401){ showLogin(); return; }
    let data = await res.json();
    console.log(data);
    // Guardamos el parentFolder si existe
    currentParentFolder = data.data.parentFolder || null;
    console.log("Parent Folder:", currentParentFolder);
    data = data.data;
    if (data.type === "folder" && data.children) {
      currentItems = Object.values(data.children);
      renderPage();
    } else {
      currentItems = [];
      document.getElementById("folderContent").innerHTML =
        `<div class="text-danger">No se pudo acceder a este folder o est√° vac√≠o.</div>`;
    }
  } catch (err) { console.error(err); }
}

function renderPage() {
  const container = document.getElementById("folderContent");
  container.innerHTML = "";

  // Bot√≥n para ir al folder padre
  if(currentParentFolder){
    const parentBtn = document.createElement("button");
    parentBtn.className = "btn btn-warning mb-2";
    parentBtn.innerText = "<-- Folder Padre";
    parentBtn.onclick = () => showFolder(currentParentFolder);
    container.appendChild(parentBtn);
  }

  const start = currentPage * itemsPerPage;
  const end = start + itemsPerPage;
  const pageItems = currentItems.slice(start, end);

  pageItems.forEach((item, index) => {
    const div = document.createElement("div");
    div.className = "folder-row d-flex justify-content-between align-items-center";

    const left = document.createElement('div');
    left.className = 'folder-list-flex';

    if (item.type === 'folder') {
      const preview = document.createElement('img');
      preview.className = 'preview-thumb';
      preview.alt = 'preview';
      preview.src = MM_PLACEHOLDER;
      // if folder provides a thumbnail property, use it; otherwise try first child's thumbnail
      if(item.thumbnail) preview.src = item.thumbnail;
      else (async ()=>{
        try{
          const res = await authFetch(`http://40.233.25.130:8000/get_content?content_id=${encodeURIComponent(item.id)}`);
          if(!res.ok) return;
          const d = await res.json();
          const children = Object.values(d.data.children || {});
          // prefer child's thumbnail, then child's link if child is image
          const child = children.find(c=>c.thumbnail || (c.mimetype && c.mimetype.startsWith('image')));
          if(child){
            // try to use blob pool slot for this page index
            const slotIndex = index % itemsPerPage;
            const url = await ensureBlobForSlot(slotIndex, { id: child.id, link: child.thumbnail || child.link });
            preview.src = url || child.thumbnail || child.link || MM_PLACEHOLDER;
          }
        }catch(e){ /* ignore preview errors */ }
      })();

      const title = document.createElement('div');
      title.innerHTML = `üìÅ <a href="#" onclick="showFolder('${item.id}')">${item.name}</a><div class="item-meta">${item.childrenCount || 0} items</div>`;
      left.appendChild(preview);
      left.appendChild(title);
    } else if (item.type === 'file') {
      const preview = document.createElement('img');
      preview.className = 'preview-thumb';
      preview.alt = 'file';
      // try to use blob pool for file preview
      (async ()=>{
        const slotIndex = index % itemsPerPage;
        const url = await ensureBlobForSlot(slotIndex, { id: item.id, link: item.thumbnail || item.link });
        preview.src = url || item.thumbnail || ((item.mimetype && item.mimetype.startsWith('image')) ? item.link : MM_PLACEHOLDER);
      })();
      const title = document.createElement('div');
      const typeEmoji = item.mimetype && item.mimetype.startsWith('image') ? 'üñºÔ∏è' : (item.mimetype && item.mimetype.startsWith('video') ? 'üé¨' : 'üìÑ');
      title.innerHTML = `${typeEmoji} <a href="#" onclick="openModalFolder(${index})">${item.name}</a><div class="item-meta">${(item.size/1024/1024).toFixed(2)} MB</div>`;
      left.appendChild(preview);
      left.appendChild(title);
    }

    div.appendChild(left);
    container.appendChild(div);
  });
}

function nextPage() { if ((currentPage + 1) * itemsPerPage < currentItems.length) { currentPage++; renderPage(); } }
function prevPage() { if (currentPage > 0) { currentPage--; renderPage(); } }
function changeFolder() {
  const inputId = document.getElementById("folderInput").value.trim();
  if (inputId) showFolder(inputId);
}

// ---------------------- Modal integration with MM ----------------------
function openModalFolder(itemOffset) {
  // build array of files from currentItems and transform to MM expected shape
  const files = currentItems.filter(i => i.type === 'file');
  if (!files.length) return;
  modalItems = files;
  modalIndex = itemOffset || 0;
  const mmItems = files.map(f => ({
    title: f.name,
    url: addProxySizeParams(f.link),
    type: f.mimetype || (f.mimetype || 'image/jpeg'),
    size: f.size || 0,
    thumbnail: f.thumbnail || f.link
  }));
  // open the modal using the shared MM module
  try{
    MM.openModalWithOptions(mmItems, { startIndex: modalIndex, carousel: 'bottom', preload: 2 });
  }catch(err){
    console.error('MM open error', err);
  }
}

// ---------------------- Folders Registrados ----------------------
async function registerFolder() {
  const name = document.getElementById("folderName").value.trim();
  const content_id = document.getElementById("folderId").value.trim();
  const source = document.getElementById("folderSource").value || 'gofile';
  if (!name || !content_id) return alert("Rellena ambos campos");

  const payload = { name, content_id, source };
  const res = await authFetch("http://40.233.25.130:8000/folders", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });
  const data = await res.json();
  if(!res.ok) { alert(data.detail || "Error"); return; }
  alert(data.message);
  loadFolders();
}

// If user selects pixeldrain and wants metadata, try to resolve via backend and prefill name
async function fetchExternalMetadata(){
  const content_id = document.getElementById("folderId").value.trim();
  const source = document.getElementById("folderSource").value;
  if(!content_id) return alert('Ingresa un ID primero');
  if(source === 'pixeldrain'){
    try{
      const res = await fetch(`http://40.233.25.130:8000/pixeldrain/resolve?content_id=${encodeURIComponent(content_id)}`);
      if(!res.ok) { const d = await res.json().catch(()=>({detail:'error'})); return alert(d.detail||'No encontrado'); }
      const data = await res.json();
      if(data.type === 'list'){
        document.getElementById('folderName').value = data.data.title || ('pixeldrain list ' + content_id);
      } else if(data.type === 'file'){
        document.getElementById('folderName').value = data.data.name || ('pixeldrain file ' + content_id);
      }
    }catch(e){ console.error(e); alert('Error al obtener metadata'); }
  } else {
    alert('Solo soporte de metadata para pixeldrain por ahora');
  }
}

async function loadFolders() {
  const res = await authFetch("http://40.233.25.130:8000/folders");
  if(res.status===401){ showLogin(); return; }
  const folders = await res.json();
  const ul = document.getElementById("foldersList");
  ul.innerHTML = "";
  folders.forEach(f => {
    const li = document.createElement("li");
    li.className = "list-group-item d-flex align-items-center";

    const left = document.createElement('div');
    left.className = 'd-flex align-items-center gap-2';

  const thumb = document.createElement('img');
  thumb.className = 'preview-thumb';
  thumb.src = f.thumbnail || MM_PLACEHOLDER;
  thumb.alt = f.name || 'folder';

    const title = document.createElement('div');
  // include a marker for external sources
  const badge = f.source && f.source !== 'gofile' ? (` <span class="badge bg-info text-dark">${f.source}</span>`) : '';
  title.innerHTML = `<a class="folder-link" href="#" onclick="onRegisteredFolderClick('${f.content_id}', '${f.source || 'gofile'}')">${f.name}</a>${badge}<div class="folder-meta">${f.content_id}</div>`;

    left.appendChild(thumb);
    left.appendChild(title);

    li.appendChild(left);
    ul.appendChild(li);
  });
}

// When a registered folder is clicked: if it points to a file, show that file directly; otherwise open folder
async function onRegisteredFolderClick(contentId, source='gofile'){
  try{
    if(source === 'pixeldrain'){
      // ask backend to resolve if this id is a list or file
      const res = await fetch(`http://40.233.25.130:8000/pixeldrain/resolve?content_id=${encodeURIComponent(contentId)}`);
      if(!res.ok) { const d = await res.json().catch(()=>({detail:'error'})); return alert(d.detail||'No encontrado'); }
      const data = await res.json();
      if(data.type === 'file'){
        // build mm item using backend pixeldrain file proxy and thumbnail
        const file = data.data;
        const mmItem = {
          title: file.name || file.id || file['name'] || file['id'] || contentId,
          url: `http://40.233.25.130:8000/pixeldrain/file?file_id=${encodeURIComponent(contentId)}`,
          type: file.mime_type || file.mimeType || file['mime_type'] || 'application/octet-stream',
          size: file.size || file['size'] || 0,
          thumbnail: `http://40.233.25.130:8000/pixeldrain/thumbnail?file_id=${encodeURIComponent(contentId)}&width=128&height=128`
        };
        // open modal
        if(window.__MM_AUTH_HEADERS === undefined) window.__MM_AUTH_HEADERS = {};
        if(token) window.__MM_AUTH_HEADERS[mmItem.url] = { Authorization: 'Bearer ' + token };
        MM.openModalWithOptions([mmItem], { startIndex:0, carousel:'bottom', preload:1 });
        return;
      } else if(data.type === 'list'){
        // show list contents in folder view by mapping pixeldrain files to currentItems
        const files = data.data.files || data.data.files || [];
        currentItems = files.map(f => ({ id: f.id || f['id'], name: f.name || f['name'], type: 'file', mimetype: f.mime_type || f['mime_type'] || 'application/octet-stream', size: f.size || f['size'] || 0, link: `http://40.233.25.130:8000/pixeldrain/file?file_id=${encodeURIComponent(f.id || f['id'])}`, thumbnail: `http://40.233.25.130:8000/pixeldrain/thumbnail?file_id=${encodeURIComponent(f.id || f['id'])}&width=240&height=160` }));
        currentPage = 0;
        renderPage();
        return;
      }
    }

    // default: treat as gofile content id
    const res = await authFetch(`http://40.233.25.130:8000/get_content?content_id=${encodeURIComponent(contentId)}`);
    if(res.status===401){ showLogin(); return; }
    let data = await res.json();
    const d = data.data;
    if(d.type === 'file'){
      currentItems = [d];
      currentPage = 0;
      renderPage();
      const mmItem = { title: d.name, url: addProxySizeParams(d.link), type: d.mimetype, size: d.size||0, thumbnail: d.thumbnail||d.link };
      if(window.__MM_AUTH_HEADERS === undefined) window.__MM_AUTH_HEADERS = {};
      if(token) window.__MM_AUTH_HEADERS[mmItem.url] = { Authorization: 'Bearer ' + token };
      MM.openModalWithOptions([mmItem], { startIndex:0, carousel:'bottom', preload:1 });
    } else {
      showFolder(contentId);
    }
  }catch(e){ console.error('registered click error', e); showFolder(contentId); }
}

// ---------------------- Inicial ----------------------
if(token) { showDashboard(); } else { showLogin(); }
</script>

</body>
</html>
